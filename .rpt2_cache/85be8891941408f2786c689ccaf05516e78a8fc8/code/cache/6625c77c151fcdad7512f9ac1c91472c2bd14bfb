{"code":"import { __decorate, __metadata } from \"tslib\";\r\nimport { Injectable, Injector } from '@angular/core';\r\nimport { HttpClient, HttpParams } from '@angular/common/http';\r\nimport { UtilityService } from './utility.service';\r\nimport { catchError, filter, finalize, switchMap, take } from 'rxjs/operators';\r\nimport { ConfigurationService } from './configuration.service';\r\nimport { BehaviorSubject, of } from 'rxjs';\r\nimport { ActivatedRoute, Router } from '@angular/router';\r\nimport { JwtHelperService } from '@auth0/angular-jwt';\r\nlet LoginService = class LoginService {\r\n    constructor(http, utilityService, configurationService, router, activatedRoute, injector) {\r\n        this.http = http;\r\n        this.utilityService = utilityService;\r\n        this.configurationService = configurationService;\r\n        this.router = router;\r\n        this.activatedRoute = activatedRoute;\r\n        this.injector = injector;\r\n        this.jwtHelper = new JwtHelperService();\r\n        this.isRefreshingToken = false;\r\n        this.tokenSubject = new BehaviorSubject(null);\r\n        // empty\r\n    }\r\n    getAccountToken(email, password) {\r\n        const data = {\r\n            \"payload\": {\r\n                \"username\": email,\r\n                \"password\": password\r\n            }\r\n        };\r\n        return this.http\r\n            .post(this.configurationService.baseUrl + '/api/Accounts/account', data);\r\n    }\r\n    getAccountTokenByAuthority(code, verifyToken, authority) {\r\n        const data = {\r\n            \"AuthorityType\": authority,\r\n            \"payload\": {\r\n                \"code\": code\r\n            },\r\n            \"token\": verifyToken\r\n        };\r\n        return this.http\r\n            .post(this.configurationService.baseUrl + `/api/Accounts/account`, data);\r\n    }\r\n    getlogintoken(auth_token) {\r\n        const payload = new HttpParams()\r\n            .set('auth_token', auth_token)\r\n            .set('grant_type', 'authentication')\r\n            .set('client_id', 'MagnarClientId')\r\n            .set('client_secret', 'MagnarClientIdKey')\r\n            .set('scope', 'offline_access');\r\n        return this.http\r\n            .post(this.configurationService.authorityUrl + '/connect/token', payload);\r\n    }\r\n    refreshtoken(refreshToken) {\r\n        const payload = new HttpParams()\r\n            .set('refresh_token', refreshToken)\r\n            .set('grant_type', 'refresh_token')\r\n            .set('client_id', 'MagnarClientId')\r\n            .set('client_secret', 'MagnarClientIdKey');\r\n        return this.http\r\n            .post(this.configurationService.authorityUrl + '/connect/token', payload)\r\n            .pipe(catchError(e => {\r\n            return of(false);\r\n        }));\r\n    }\r\n    isTokenExpired(token) {\r\n        if (!token || token == 'null')\r\n            return true;\r\n        try {\r\n            return this.jwtHelper.isTokenExpired(token);\r\n        }\r\n        catch (error) {\r\n            return true;\r\n        }\r\n    }\r\n    fillLoginInfo(response) {\r\n        localStorage.setItem('Logintoken', response.access_token);\r\n        localStorage.setItem('Refreshtoken', response.refresh_token);\r\n        this.tokenSubject.next(response.access_token);\r\n    }\r\n    tokenCheck() {\r\n        const localtoken = localStorage.getItem('Logintoken');\r\n        const refreshToken = localStorage.getItem('Refreshtoken');\r\n        if (!this.isTokenExpired(localtoken)) {\r\n            return of(localtoken);\r\n        }\r\n        else if (this.isTokenExpired(localtoken) && this.isRefreshingToken) {\r\n            return this.tokenSubject.pipe(filter(token => token != null), take(1), switchMap(token => {\r\n                return of(token);\r\n            }));\r\n        }\r\n        else if (this.isTokenExpired(localtoken) && !this.isRefreshingToken) {\r\n            this.isRefreshingToken = true;\r\n            this.tokenSubject.next(null);\r\n            return this.refreshtoken(refreshToken).pipe(switchMap((response) => {\r\n                if (response) {\r\n                    const token = response.access_token;\r\n                    this.fillLoginInfo(response);\r\n                    return of(token);\r\n                }\r\n            }), finalize(() => {\r\n                this.isRefreshingToken = false;\r\n            }));\r\n        }\r\n    }\r\n    refreshTokenForce() {\r\n        const refreshToken = localStorage.getItem('Refreshtoken');\r\n        if (this.isRefreshingToken) {\r\n            return this.tokenSubject.pipe(filter(token => token != null), take(1), switchMap(token => {\r\n                return of(token);\r\n            }));\r\n        }\r\n        else if (!this.isRefreshingToken) {\r\n            this.isRefreshingToken = true;\r\n            this.tokenSubject.next(null);\r\n            return this.refreshtoken(refreshToken).pipe(switchMap((response) => {\r\n                if (response) {\r\n                    const token = response.access_token;\r\n                    this.fillLoginInfo(response);\r\n                    return of(token);\r\n                }\r\n            }), finalize(() => {\r\n                this.isRefreshingToken = false;\r\n            }));\r\n        }\r\n    }\r\n    refreshTokenAutomatically(active) {\r\n        if (active) {\r\n            this.interval = setInterval(() => {\r\n                const localtoken = localStorage.getItem('Logintoken');\r\n                if (this.jwtHelper.isTokenExpired(localtoken, 10)) {\r\n                    this.refreshTokenForce().subscribe();\r\n                }\r\n            }, 5000);\r\n        }\r\n        else {\r\n            clearInterval(this.interval);\r\n        }\r\n    }\r\n};\r\nLoginService = __decorate([\r\n    Injectable(),\r\n    __metadata(\"design:paramtypes\", [HttpClient,\r\n        UtilityService,\r\n        ConfigurationService,\r\n        Router,\r\n        ActivatedRoute,\r\n        Injector])\r\n], LoginService);\r\nexport { LoginService };\r\n//# sourceMappingURL=login.service.js.map","map":{"version":3,"file":"login.service.js","sourceRoot":"","sources":["../../src/app/service/login.service.ts"],"names":[],"mappings":"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"}}
